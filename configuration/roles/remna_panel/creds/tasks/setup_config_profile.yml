---
- name: Set Panel API Token Fact
  ansible.builtin.set_fact:
    panel_api_token: "{{ remnawave_api_token | default(lookup('env', 'PANEL_API_TOKEN')) }}"

# The panel has an endpoint that generates a batch of 30 x25519 keys
- name: Generate X25519 Keys
  ansible.builtin.uri:
    url: "https://{{ panel_domain }}/api/system/tools/x25519/generate"
    method: GET
    headers:
      Authorization: "Bearer {{ panel_api_token }}"
      Content-Type: "application/json"
    status_code: 200
    validate_certs: false
  register: x25519_response
  retries: 5
  delay: 3
  until: x25519_response.status == 200

- name: Set Private Key Fact
  ansible.builtin.set_fact:
    generated_private_key_1: "{{ x25519_response.json.response.keypairs[0].privateKey }}"
    generated_private_key_2: "{{ x25519_response.json.response.keypairs[1].privateKey }}"

# Patching the Default-Profile with our template
- name: Get Config Profiles
  ansible.builtin.uri:
    url: "https://{{ panel_domain }}/api/config-profiles"
    method: GET
    headers:
      Authorization: "Bearer {{ panel_api_token }}"
    status_code: 200
  register: profiles_response
  retries: 5
  delay: 3
  until: profiles_response.status == 200

- name: Get Default Profile
  ansible.builtin.set_fact:
    default_profile: "{{ profiles_response.json.response.configProfiles | first }}"

- name: Update Default Config Profile
  ansible.builtin.uri:
    url: "https://{{ panel_domain }}/api/config-profiles"
    method: PATCH
    body_format: json
    headers:
      Authorization: "Bearer {{ panel_api_token }}"
    body:
      uuid: "{{ default_profile.uuid }}"
      config: "{{ lookup('template', 'config.json.j2') | from_json }}"
    status_code: 200
  register: update_profile_response
  retries: 5
  delay: 3
  until: update_profile_response.status == 200
  vars:
    privateKey1: "{{ generated_private_key_1 }}"
    privateKey2: "{{ generated_private_key_2 }}"

- name: Capture Profile UUID and Inbounds
  ansible.builtin.set_fact:
    profile_uuid: "{{ update_profile_response.json.response.uuid }}"
    inbound_uuids: "{{ update_profile_response.json.response.inbounds | map(attribute='uuid') | list }}"

- name: Write CONFIG_PROFILE_UUID to .env
  ansible.builtin.lineinfile:
    path: "{{ playbook_dir }}/../../.env"
    regexp: "^CONFIG_PROFILE_UUID="
    line: "CONFIG_PROFILE_UUID='{{ profile_uuid }}'"
    create: true
  delegate_to: localhost
  become: false

- name: Write ACTIVE_INBOUNDS to .env
  ansible.builtin.lineinfile:
    path: "{{ playbook_dir }}/../../.env"
    regexp: "^ACTIVE_INBOUNDS="
    line: "ACTIVE_INBOUNDS='{{ inbound_uuids | to_json }}'"
    create: true
  delegate_to: localhost
  become: false
