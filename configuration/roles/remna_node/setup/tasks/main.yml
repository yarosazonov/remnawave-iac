---
- name: Create Application Directory
  ansible.builtin.file:
    path: /opt/remnanode
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Create App Log Directory
  ansible.builtin.file:
    path: /var/log/remnanode
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Allow Node API Port (from Panel IP only)
  vars:
    node_port: "{{ lookup('ansible.builtin.env', 'NODE_PORT') | default('') }}"
    panel_ip: "{{ lookup('ansible.builtin.env', 'PANEL_IP') | default('') }}"
  community.general.ufw:
    rule: allow
    port: "{{ node_port }}"
    proto: tcp
    from_ip: "{{ panel_ip }}"
  when: node_port | length > 0 and panel_ip | length > 0

- name: Generate .env from Template
  ansible.builtin.template:
    src: env.j2
    dest: /opt/remnanode/.env
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"

- name: Copy docker-compose.yml
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: /opt/remnanode/docker-compose.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: Deploy Docker Compose Stack
  community.docker.docker_compose_v2:
    project_src: /opt/remnanode
    state: present
    pull: missing
    build: never
  register: compose_output

- name: Show Deployment Status
  ansible.builtin.debug:
    var: compose_output.actions
